{"version":3,"file":"index.mjs","sources":["../src/index.ts"],"sourcesContent":["import { type Plugin } from \"vite\";\n\nexport type StripCommentsPlugin = Plugin<StripCommentsConfig> & {\n  name: string;\n  enforce: \"pre\" | \"post\" | undefined;\n  apply: \"build\";\n  transform: (\n    code: string,\n    id?: string,\n  ) => {\n    code: string;\n    map: string | null;\n  };\n};\n\nexport type StripCommentsConfig = {\n  type: \"none\" | \"keep-legal\" | \"keep-jsdoc\";\n  enforce: \"pre\" | \"post\" | undefined;\n};\n\nconst StripCommentsDefaultConfig: StripCommentsConfig = {\n  type: \"keep-legal\",\n  enforce: \"pre\",\n};\n\nconst stripComments = (cfg: Partial<StripCommentsConfig> = {}) => {\n  const config: Partial<StripCommentsConfig> = {\n    type: [\"none\", \"keep-legal\", \"keep-jsdoc\"].some((x) => x === cfg.type)\n      ? cfg.type\n      : StripCommentsDefaultConfig.type,\n    enforce: [\"pre\", \"post\"].some((x) => x === cfg.enforce)\n      ? cfg.enforce\n      : StripCommentsDefaultConfig.enforce,\n  };\n\n  return {\n    name: \"vite-plugin-strip-comments\",\n    enforce: config.enforce,\n    apply: \"build\",\n    transform(code: string, id?: string): { code: string; map: null } {\n      /* istanbul ignore if @preserve */\n      if (!id || id.includes(\"node_modules\") || !/\\.([jt]sx?)$/.test(id)) {\n        return { code, map: null };\n      }\n      let result = code;\n      let match: string;\n\n      const matchesArray = Array.from(\n        code.matchAll(\n          /\\/\\*[\\s\\S]*?\\*\\/|\\/\\*\\*.*?\\*\\/|(?<!https?:)\\/\\/.*(?=\\n)?/gm,\n        ),\n      );\n\n      for (let i = 0; i < matchesArray.length; i += 1) {\n        // first match\n        [match] = matchesArray[i];\n        const isJSDoc = match.startsWith(\"/**\");\n        const isLegal = [\"@legal\", \"@license\", \"@copyright\"].some((x) =>\n          match.includes(x)\n        );\n        // console.log({ isJSDoc, isLegal, match });\n\n        switch (config.type) {\n          case \"keep-jsdoc\":\n            if (!isJSDoc && !isLegal) {\n              result = result.replace(match, \"\");\n            }\n            break;\n          case \"keep-legal\":\n            if (!isLegal) {\n              result = result.replace(match, \"\");\n            }\n            break;\n          case \"none\":\n          default:\n            result = result.replace(match, \"\");\n        }\n      }\n\n      return { code: result, map: null };\n    },\n  } satisfies StripCommentsPlugin;\n};\n\nexport default stripComments;\n"],"names":["StripCommentsDefaultConfig","stripComments","cfg","config","x","code","id","result","match","matchesArray","i","isJSDoc","isLegal"],"mappings":"AAoBA,MAAMA,IAAkD;AAAA,EACtD,MAAM;AAAA,EACN,SAAS;AACX,GAEMC,IAAgB,CAACC,IAAoC,OAAO;AAChE,QAAMC,IAAuC;AAAA,IAC3C,MAAM,CAAC,QAAQ,cAAc,YAAY,EAAE,KAAK,CAACC,MAAMA,MAAMF,EAAI,IAAI,IACjEA,EAAI,OACJF,EAA2B;AAAA,IAC/B,SAAS,CAAC,OAAO,MAAM,EAAE,KAAK,CAACI,MAAMA,MAAMF,EAAI,OAAO,IAClDA,EAAI,UACJF,EAA2B;AAAA,EAAA;AAGjC,SAAO;AAAA,IACL,MAAM;AAAA,IACN,SAASG,EAAO;AAAA,IAChB,OAAO;AAAA,IACP,UAAUE,GAAcC,GAA0C;AAEhE,UAAI,CAACA,KAAMA,EAAG,SAAS,cAAc,KAAK,CAAC,eAAe,KAAKA,CAAE;AAC/D,eAAO,EAAE,MAAAD,GAAM,KAAK,KAAA;AAEtB,UAAIE,IAASF,GACTG;AAEJ,YAAMC,IAAe,MAAM;AAAA,QACzBJ,EAAK;AAAA,UACH;AAAA,QAAA;AAAA,MACF;AAGF,eAASK,IAAI,GAAGA,IAAID,EAAa,QAAQC,KAAK,GAAG;AAE/C,SAACF,CAAK,IAAIC,EAAaC,CAAC;AACxB,cAAMC,IAAUH,EAAM,WAAW,KAAK,GAChCI,IAAU,CAAC,UAAU,YAAY,YAAY,EAAE;AAAA,UAAK,CAACR,MACzDI,EAAM,SAASJ,CAAC;AAAA,QAAA;AAIlB,gBAAQD,EAAO,MAAA;AAAA,UACb,KAAK;AACH,YAAI,CAACQ,KAAW,CAACC,MACfL,IAASA,EAAO,QAAQC,GAAO,EAAE;AAEnC;AAAA,UACF,KAAK;AACH,YAAKI,MACHL,IAASA,EAAO,QAAQC,GAAO,EAAE;AAEnC;AAAA,UAEF;AACE,YAAAD,IAASA,EAAO,QAAQC,GAAO,EAAE;AAAA,QAAA;AAAA,MAEvC;AAEA,aAAO,EAAE,MAAMD,GAAQ,KAAK,KAAA;AAAA,IAC9B;AAAA,EAAA;AAEJ;"}